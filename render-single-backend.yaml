# render-single-backend.yaml
# Simplest deployment: 1 backend, Redis, Frontend
# Good for initial testing or low-traffic deployments

services:
  # Redis Cache
  - type: redis
    name: tavern-redis
    plan: free
    maxmemoryPolicy: allkeys-lru

  # Single Backend Instance
  - type: web
    name: tavern-backend
    env: docker
    dockerfilePath: ./tavern-backend/Dockerfile
    dockerContext: ./tavern-backend
    plan: starter
    region: oregon
    healthCheckPath: /api/health/live
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: INSTANCE_ID
        value: backend-1
      - key: MONGO_URI
        sync: false  # Set manually: mongodb+srv://user:pass@cluster.mongodb.net/tavern_db
      - key: REDIS_HOST
        fromService:
          type: redis
          name: tavern-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: tavern-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: tavern-redis
          property: password
      - key: REDIS_DB
        value: 0
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRES_IN
        value: 7d
      - key: FRONTEND_URL
        sync: false  # Update after frontend deploys
      - key: SUPABASE_URL
        sync: false  # Optional
      - key: SUPABASE_ANON_KEY
        sync: false  # Optional
    scaling:
      minInstances: 1
      maxInstances: 1  # Can increase for auto-scaling

  # Frontend Static Site
  - type: web
    name: tavern-frontend
    env: static
    buildCommand: cd tavern-frontend && npm install && npm run build
    staticPublishPath: ./tavern-frontend/dist
    envVars:
      - key: VITE_API_URL
        value: https://tavern-backend.onrender.com/api  # Update with actual backend URL

