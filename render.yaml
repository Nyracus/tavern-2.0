# render.yaml - Render Blueprint for Tavern Platform
# This file allows deploying all services with a single click on Render
# Documentation: https://render.com/docs/blueprint-spec

services:
  # MongoDB Database (using MongoDB Atlas or external service)
  # Note: Render doesn't provide managed MongoDB, so use MongoDB Atlas
  # Set MONGO_URI in environment variables pointing to Atlas

  # Redis Cache Service
  - type: redis
    name: tavern-redis
    plan: free  # Change to starter/pro for production
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow all IPs by default, restrict in production

  # Backend Instance 1
  - type: web
    name: tavern-backend-1
    env: docker
    dockerfilePath: ./tavern-backend/Dockerfile
    dockerContext: ./tavern-backend
    plan: starter  # 512 MB RAM, 0.5 CPU
    region: oregon  # Choose your preferred region
    healthCheckPath: /api/health/live
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000  # Render assigns port dynamically
      - key: INSTANCE_ID
        value: backend-1
      - key: MONGO_URI
        sync: false  # Set manually in Render dashboard
      - key: REDIS_HOST
        fromService:
          type: redis
          name: tavern-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: tavern-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: tavern-redis
          property: password
      - key: REDIS_DB
        value: 0
      - key: JWT_SECRET
        generateValue: true  # Render will generate a secure secret
      - key: JWT_EXPIRES_IN
        value: 7d
      - key: SUPABASE_URL
        sync: false  # Set manually if using Supabase
      - key: SUPABASE_ANON_KEY
        sync: false  # Set manually if using Supabase
      - key: SMTP_HOST
        sync: false  # Set manually if using email
      - key: SMTP_PORT
        value: 587
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: FROM_NAME
        value: Tavern Quest Platform
      - key: FRONTEND_URL
        sync: false  # Set to your frontend URL
    scaling:
      minInstances: 1
      maxInstances: 1

  # Backend Instance 2
  - type: web
    name: tavern-backend-2
    env: docker
    dockerfilePath: ./tavern-backend/Dockerfile
    dockerContext: ./tavern-backend
    plan: starter
    region: oregon
    healthCheckPath: /api/health/live
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: INSTANCE_ID
        value: backend-2
      - key: MONGO_URI
        sync: false
      - key: REDIS_HOST
        fromService:
          type: redis
          name: tavern-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: tavern-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: tavern-redis
          property: password
      - key: REDIS_DB
        value: 0
      - key: JWT_SECRET
        fromService:
          type: web
          name: tavern-backend-1
          property: envVar
          value: JWT_SECRET
      - key: JWT_EXPIRES_IN
        value: 7d
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        value: 587
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: FROM_NAME
        value: Tavern Quest Platform
      - key: FRONTEND_URL
        sync: false
    scaling:
      minInstances: 1
      maxInstances: 1

  # Backend Instance 3
  - type: web
    name: tavern-backend-3
    env: docker
    dockerfilePath: ./tavern-backend/Dockerfile
    dockerContext: ./tavern-backend
    plan: starter
    region: oregon
    healthCheckPath: /api/health/live
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 10000
      - key: INSTANCE_ID
        value: backend-3
      - key: MONGO_URI
        sync: false
      - key: REDIS_HOST
        fromService:
          type: redis
          name: tavern-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: tavern-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: tavern-redis
          property: password
      - key: REDIS_DB
        value: 0
      - key: JWT_SECRET
        fromService:
          type: web
          name: tavern-backend-1
          property: envVar
          value: JWT_SECRET
      - key: JWT_EXPIRES_IN
        value: 7d
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_ANON_KEY
        sync: false
      - key: SMTP_HOST
        sync: false
      - key: SMTP_PORT
        value: 587
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: FROM_NAME
        value: Tavern Quest Platform
      - key: FRONTEND_URL
        sync: false
    scaling:
      minInstances: 1
      maxInstances: 1

  # API Gateway (Load Balancer)
  # This replaces Nginx for Render deployment
  # Uses Node.js proxy for load balancing across backend instances
  - type: web
    name: tavern-api-gateway
    env: node
    buildCommand: npm install
    startCommand: node gateway.js
    plan: starter
    region: oregon
    healthCheckPath: /health
    envVars:
      - key: BACKEND_1_URL
        fromService:
          type: web
          name: tavern-backend-1
          property: host
      - key: BACKEND_2_URL
        fromService:
          type: web
          name: tavern-backend-2
          property: host
      - key: BACKEND_3_URL
        fromService:
          type: web
          name: tavern-backend-3
          property: host
      - key: PORT
        value: 10000
    scaling:
      minInstances: 1
      maxInstances: 1

  # Frontend Static Site
  - type: web
    name: tavern-frontend
    env: static
    buildCommand: cd tavern-frontend && npm install && npm run build
    staticPublishPath: ./tavern-frontend/dist
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: tavern-api-gateway
          property: host
          # Full URL format: https://tavern-api-gateway.onrender.com/api
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
